name: Merge to Main

on:
  push:
    branches: [main]
  schedule:
    # Run weekly on Sundays at 2 AM UTC to pick up new container versions
    - cron: '0 2 * * 0'
  workflow_dispatch: # Allow manual trigger

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

permissions: {}

jobs:
  detect:
    name: Detect Containers to Build
    outputs:
      json: ${{ steps.create-matrix.outputs.json }}
      mode: ${{ steps.detect-mode.outputs.mode }}
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Detect workflow mode
        id: detect-mode
        run: |
          # Determine if this is a push (merge) or scheduled run
          if [ "${{ github.event_name }}" = "push" ]; then
            echo "mode=merge" >> $GITHUB_OUTPUT
            echo "Running in MERGE mode - will build only changed containers"
          else
            echo "mode=scheduled" >> $GITHUB_OUTPUT
            echo "Running in SCHEDULED mode - will scan all containers"
          fi

      - name: Find Dockerfiles (merge mode)
        if: github.event_name == 'push'
        id: find-merge
        run: |
          # Find Dockerfiles changed in the merge
          echo "Finding changed Dockerfiles in merge..."

          # Get the previous commit
          PREVIOUS_COMMIT="${{ github.event.before }}"
          CURRENT_COMMIT="${{ github.sha }}"

          echo "Comparing $PREVIOUS_COMMIT to $CURRENT_COMMIT"

          # Get changed files in this push
          CHANGED_FILES=$(git diff --name-only "$PREVIOUS_COMMIT" "$CURRENT_COMMIT")
          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Filter for Dockerfiles matching pattern: package/version/Dockerfile
          DOCKERFILES=$(echo "$CHANGED_FILES" | grep -E '^[^/]+/[^/]+/Dockerfile$' | sort -u || true)

          echo "Changed Dockerfiles:"
          echo "$DOCKERFILES"
          echo "$DOCKERFILES" > /tmp/dockerfiles.txt

      - name: Find all Dockerfiles (scheduled mode)
        if: github.event_name != 'push'
        id: find-scheduled
        run: |
          # Find all Dockerfiles in the repository
          echo "Finding all Dockerfiles for scheduled build..."

          # Find all Dockerfiles matching the pattern
          find . -type f -path '*/*/Dockerfile' | grep -E '^\./[^/]+/[^/]+/Dockerfile$' | sed 's|^\./||' | sort > /tmp/dockerfiles.txt

          echo "All Dockerfiles found:"
          cat /tmp/dockerfiles.txt

      - name: Create build matrix
        id: create-matrix
        run: |
          # Convert the list of Dockerfiles into a JSON matrix for parallel builds
          echo "Creating build matrix..."

          # Read the Dockerfile list
          DOCKERFILES=$(cat /tmp/dockerfiles.txt)

          # Build JSON array
          JSON_ITEMS=""
          while IFS= read -r dockerfile; do
            if [ -n "$dockerfile" ]; then
              # Extract package and major version from path
              # Pattern: package/major_tag/Dockerfile
              PACKAGE=$(echo "$dockerfile" | cut -d'/' -f1)
              MAJOR_TAG=$(echo "$dockerfile" | cut -d'/' -f2)

              echo "Found: package=$PACKAGE, major_tag=$MAJOR_TAG"

              # Add to JSON array
              JSON_ITEMS="${JSON_ITEMS}{\"package\": \"${PACKAGE}\", \"major_tag\": \"${MAJOR_TAG}\"},"
            fi
          done <<< "$DOCKERFILES"

          # Remove trailing comma and wrap in array brackets
          if [ -n "$JSON_ITEMS" ]; then
            JSON_ITEMS=${JSON_ITEMS%,}  # Remove last comma
            JSON="[${JSON_ITEMS}]"
          else
            JSON="[]"
          fi

          # Output the matrix
          echo "Build matrix: $JSON"
          echo "json=$JSON" >> $GITHUB_OUTPUT

  # Build container images using the bcgov/action-builder-ghcr action
  # See: https://github.com/bcgov/action-builder-ghcr
  builds:
    name: Build Container Images
    needs: [detect]
    # Only run if there are Dockerfiles to build
    if: needs.detect.outputs.json != '[]'
    permissions:
      attestations: write
      id-token: write
      packages: write
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        # Build each Dockerfile in parallel
        include: ${{ fromJSON(needs.detect.outputs.json) }}
      # Allow partial failures in scheduled mode (some base images may be unavailable)
      fail-fast: false
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Extract version tag from Dockerfile
        id: tag
        run: |
          # Get the full tag from the FROM statement in the Dockerfile
          DOCKERFILE_PATH="${{ matrix.package }}/${{ matrix.major_tag }}/Dockerfile"
          echo "Reading tag from: $DOCKERFILE_PATH"

          # Extract tag from FROM statement (e.g., "FROM postgres:16.10" -> "16.10")
          TAG=$(grep '^FROM' "$DOCKERFILE_PATH" | cut -d':' -f2)

          echo "Extracted tag: $TAG"
          echo "full_tag=${TAG}" >> $GITHUB_OUTPUT

      - name: Build and push container image
        uses: bcgov/action-builder-ghcr@cde7f10b0441b6dd3c1da3e6a54ac05899e8eed9 # 4.2.0
        with:
          build_context: ${{ matrix.package }}/${{ matrix.major_tag }}
          build_file: ${{ matrix.package }}/${{ matrix.major_tag }}/Dockerfile
          package: ${{ matrix.package }}
          tags: ${{ steps.tag.outputs.full_tag }}

  results:
    name: Report Build Results
    needs: [detect, builds]
    if: always()
    runs-on: ubuntu-24.04
    steps:
      - name: Check for failures
        if: contains(needs.*.result, 'failure') || contains(needs.*.result, 'canceled')
        run: |
          echo "⚠️  Some builds failed or were canceled."
          if [ "${{ needs.detect.outputs.mode }}" = "scheduled" ]; then
            echo "This was a scheduled run - some failures are acceptable."
            exit 0
          else
            echo "This was a merge - failing the workflow."
            exit 1
          fi

      - name: Report success
        run: echo "✅ All builds completed successfully!"
