name: PR

on:
  pull_request:
    branches: [main]

concurrency:
  # PR open and close use the same group, allowing only one at a time
  group: pr-${{ github.workflow }}-${{ github.event.number }}
  cancel-in-progress: true

permissions: {}

jobs:
  checks:
    name: Detect Changed Dockerfiles
    outputs:
      json: ${{ steps.create-matrix.outputs.json }}
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Fetch base branch
        run: |
          # Fetch the base branch to compare against
          echo "Fetching base branch: ${{ github.event.repository.default_branch }}"
          git fetch origin ${{ github.event.repository.default_branch }}

      - name: Find changed Dockerfiles
        id: find-dockerfiles
        run: |
          # Find all Dockerfiles that changed compared to the base branch
          echo "Finding changed Dockerfiles..."

          # Get the list of changed files
          CHANGED_FILES=$(git diff --name-only origin/${{ github.event.repository.default_branch }})
          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Filter for Dockerfiles (pattern matches any path with at least 2 levels + Dockerfile)
          # This matches both: package/version/Dockerfile AND package/subpackage/version/Dockerfile
          DOCKERFILES=$(echo "$CHANGED_FILES" | grep -E '^.*/.*/Dockerfile$' | sort -u || true)

          # Save the list
          echo "Changed Dockerfiles:"
          echo "$DOCKERFILES"
          echo "$DOCKERFILES" > /tmp/dockerfiles.txt

      - name: Create build matrix
        id: create-matrix
        run: |
          # Convert the list of Dockerfiles into a JSON matrix for parallel builds
          echo "Creating build matrix..."

          # Read the Dockerfile list
          DOCKERFILES=$(cat /tmp/dockerfiles.txt)

          # Build JSON array
          JSON_ITEMS=""
          while IFS= read -r dockerfile; do
            if [ -n "$dockerfile" ]; then
              # Extract package and major version from path
              # For "package/version/Dockerfile" or "package/subpackage/version/Dockerfile"
              # Remove "/Dockerfile" suffix
              BASE=${dockerfile%/*}
              # Package is everything except the last directory
              PACKAGE=${BASE%/*}
              # Major tag is the last directory before Dockerfile
              MAJOR_TAG=${BASE##*/}

              echo "Found: package=$PACKAGE, major_tag=$MAJOR_TAG"

              # Add to JSON array
              JSON_ITEMS="${JSON_ITEMS}{\"package\": \"${PACKAGE}\", \"major_tag\": \"${MAJOR_TAG}\"},"
            fi
          done <<< "$DOCKERFILES"

          # Remove trailing comma and wrap in array brackets
          if [ -n "$JSON_ITEMS" ]; then
            JSON_ITEMS=${JSON_ITEMS%,}  # Remove last comma
            JSON="[${JSON_ITEMS}]"
          else
            JSON="[]"
          fi

          # Output the matrix
          echo "Build matrix: $JSON"
          echo "json=$JSON" >> $GITHUB_OUTPUT

  # Build container images using the bcgov/action-builder-ghcr action
  # See: https://github.com/bcgov/action-builder-ghcr
  builds:
    name: Build Container Images
    needs: [checks]
    # Only run if there are Dockerfiles to build
    if: needs.checks.outputs.json != '[]'
    permissions:
      attestations: write
      id-token: write
      packages: write
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        # Build each changed Dockerfile in parallel
        include: ${{ fromJSON(needs.checks.outputs.json) }}
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Extract version tag from Dockerfile
        id: tag
        run: |
          # Get the full tag from the FROM statement in the Dockerfile
          DOCKERFILE_PATH="${{ matrix.package }}/${{ matrix.major_tag }}/Dockerfile"
          echo "Reading tag from: $DOCKERFILE_PATH"

          # Extract tag from FROM statement (e.g., "FROM postgres:16.10" -> "16.10")
          TAG=$(grep '^FROM' "$DOCKERFILE_PATH" | cut -d':' -f2)

          echo "Extracted tag: $TAG"
          echo "full_tag=${TAG}" >> $GITHUB_OUTPUT

      - name: Build and push container image
        uses: bcgov/action-builder-ghcr@cde7f10b0441b6dd3c1da3e6a54ac05899e8eed9 # 4.2.0
        with:
          build_context: ${{ matrix.package }}/${{ matrix.major_tag }}
          build_file: ${{ matrix.package }}/${{ matrix.major_tag }}/Dockerfile
          package: ${{ matrix.package }}
          tags: ${{ steps.tag.outputs.full_tag }}

  results:
    name: Report PR Results
    needs: [builds, checks]
    permissions:
      pull-requests: write
    if: always()
    runs-on: ubuntu-24.04
    steps:
      - name: Check for failures
        if: contains(needs.*.result, 'failure') || contains(needs.*.result, 'canceled')
        run: |
          echo "❌ At least one job has failed or was canceled."
          exit 1

      - name: Report success
        run: echo "✅ All checks passed successfully!"

      - name: Add comment to PR
        uses: bcgov/action-pr-description-add@d79a5c3b49d3b3b3215495afac3ae599cef191bb # v2.0.1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          add_markdown: |
            ---

            Thanks for the PR!  Our PR workflow has completed successfully.  :)

            Any new images should be viewable with [our repo packages](https://github.com/orgs/bcgov/packages?repo_name=nr-containers).
